<!-- Loading -->
<div *ngIf="loading" class="min-h-screen bg-[#111416] flex items-center justify-center text-slate-300">
  Cargando ejercicio...
</div>

<!-- Error -->
<div *ngIf="!loading && errorMessage" class="min-h-screen bg-[#111416] flex items-center justify-center text-red-400">
  {{ errorMessage }}
</div>

<!-- Contenido principal -->
<div
  *ngIf="!loading && data as d"
  class="min-h-screen bg-[#111416] text-slate-50 flex justify-center"
>
  <!-- Contenedor tipo ‚Äútel√©fono‚Äù, pero responsivo -->
  <div class="w-full max-w-md md:max-w-lg lg:max-w-xl flex flex-col pb-8">

    <!-- Header con timer -->
    <header class="px-4 pt-4 pb-1 flex items-center justify-between">
      <div class="text-lg md:text-xl font-semibold tabular-nums">
        {{ timerLabel }}
      </div>

      <button
        (click)="onBack()"
        class="text-slate-400 hover:text-slate-100 text-xl leading-none"
        aria-label="Cerrar sesi√≥n"
      >
        ‚úï
      </button>
    </header>

    <p class="px-4 text-xs md:text-sm text-emerald-400 -mt-0.5 mb-2">
      Sesi√≥n activa
    </p>

    <!-- Video / imagen -->
    <section class="px-4">
      <div
        class="relative rounded-3xl overflow-hidden bg-slate-900 aspect-video shadow-[0_18px_50px_rgba(0,0,0,0.85)]"
      >
        <!-- Video embebido si es YouTube -->
        <ng-container *ngIf="youtubeEmbedUrl">
          <iframe
            [src]="youtubeEmbedUrl | safe:'resourceUrl'"
            class="absolute inset-0 w-full h-full"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </ng-container>

        <!-- Video directo MP4 -->
        <ng-container *ngIf="isDirectVideo">
          <video
            [src]="d.exerciseVideoUrl"
            class="absolute inset-0 w-full h-full object-cover"
            controls
            playsinline
          ></video>
        </ng-container>

        <!-- Placeholder si no hay video -->
        <ng-container *ngIf="!hasVideo">
          <div class="absolute inset-0 bg-gradient-to-b from-slate-800 via-slate-900 to-black flex items-center justify-center">
            <div class="text-center">
              <span class="text-6xl mb-2 block opacity-30">üèãÔ∏è</span>
              <p class="text-slate-500 text-xs">Sin video disponible</p>
            </div>
          </div>
        </ng-container>

        <!-- Overlay inferior con nombre y descanso -->
        <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/90 via-black/60 to-transparent pointer-events-none">
          <h1 class="text-base md:text-lg font-semibold">
            {{ d.exerciseName }}
          </h1>
          <p class="text-xs md:text-sm text-slate-300 mt-1">
            {{ (d.plannedRestSeconds / 60) | number:'1.0-0' }}‚Ä≤ descanso entre series
          </p>
        </div>
      </div>
    </section>

    <!-- Progreso -->
    <section class="px-4 mt-3 md:mt-4">
      <div class="flex items-center justify-between text-[11px] md:text-xs text-slate-400">
        <span>
          {{ d.progress.currentExerciseOrder }}/{{ d.progress.totalExercises }} ejercicios completados
          ({{ d.progress.progressPercentage | number:'1.0-0' }}%)
        </span>
        <span class="text-emerald-400 font-semibold">
          +{{ d.progress.xpEarned }} XP ganados
        </span>
      </div>

      <div class="w-full bg-slate-800 rounded-full h-2 mt-2 overflow-hidden">
        <div
          class="h-2 bg-emerald-400 transition-all"
          [style.width.%]="d.progress.progressPercentage"
        ></div>
      </div>
    </section>

    <!-- Tarjeta principal del ejercicio -->
    <section class="px-4 mt-4">
      <div class="bg-[#11151a] rounded-3xl p-4 md:p-5 shadow-[0_18px_50px_rgba(0,0,0,0.7)] border border-slate-800">
        <h2 class="font-semibold text-sm md:text-base mb-3">
          {{ d.exerciseName }}
        </h2>

        <div class="flex flex-wrap gap-2 text-[10px] md:text-[11px]">
          <span
            class="inline-flex items-center px-3 py-1 rounded-full bg-amber-500 text-slate-950 font-semibold tracking-wide"
          >
            {{ d.plannedSets }} SERIES
          </span>

          <span
            class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-500/15 border border-emerald-300 text-emerald-200 font-semibold tracking-wide"
          >
            {{ d.plannedRepsMin }}‚Äì{{ d.plannedRepsMax }} REPS
          </span>

          <span
            class="inline-flex items-center px-3 py-1 rounded-full bg-slate-900 border border-slate-600"
          >
            {{ d.plannedRir }} RIR
          </span>

          <span
            class="inline-flex items-center px-3 py-1 rounded-full bg-slate-900 border border-slate-600"
          >
            {{ d.plannedRestSeconds / 60 | number:'1.0-0' }}‚Ä≤ entre series
          </span>
        </div>
      </div>
    </section>

    <!-- Registro de series -->
    <section class="px-4 mt-5">
      <h3 class="font-semibold text-sm md:text-base mb-3">
        Registro de series
      </h3>

      <div class="space-y-3 text-xs md:text-sm">
        <div
          *ngFor="let s of currentSets; index as i"
          class="grid grid-cols-[auto_1fr_1fr_auto] items-center gap-2 md:gap-3"
        >
          <span class="text-slate-400">Serie {{ i + 1 }}</span>

          <input
            type="number"
            class="w-full bg-[#10141a] border border-slate-700 rounded-2xl px-3 py-2 text-xs md:text-sm
                   focus:outline-none focus:border-emerald-400"
            placeholder="Reps"
            [(ngModel)]="currentSets[i].reps"
          />

          <input
            type="number"
            class="w-full bg-[#10141a] border border-slate-700 rounded-2xl px-3 py-2 text-xs md:text-sm
                   focus:outline-none focus:border-emerald-400"
            placeholder="kg"
            [(ngModel)]="currentSets[i].weightKg"
          />

          <button
            type="button"
            class="w-8 h-8 md:w-9 md:h-9 rounded-xl border flex items-center justify-center transition"
            [ngClass]="currentSets[i].completed ? 'border-emerald-400 bg-emerald-400/20' : 'border-slate-700'"
            (click)="onToggleSetCompleted(i)"
          >
            <span *ngIf="currentSets[i].completed">‚úî</span>
          </button>
        </div>
      </div>

      <!-- Serie anterior -->
      <p *ngIf="d.previousSet" class="mt-3 text-[11px] md:text-xs text-slate-400">
        Serie anterior:
        {{ d.previousSet.reps }} reps √ó {{ d.previousSet.weightKg }} kg
      </p>
    </section>

    <!-- Notas -->
    <section class="px-4 mt-5">
      <h3 class="font-semibold text-sm md:text-base mb-2">
        Tus notas +
      </h3>

      <textarea
        rows="3"
        class="w-full bg-[#10141a] border border-slate-700 rounded-2xl px-3 py-2 text-xs md:text-sm
               placeholder:text-slate-500 focus:outline-none focus:border-emerald-400"
        placeholder="Agrega observaciones sobre esta sesi√≥n..."
        [(ngModel)]="notes"
      ></textarea>
    </section>

    <!-- Bot√≥n registrar -->
    <section class="px-4 mt-5">
      <button
        (click)="onRegisterAndContinue()"
        [disabled]="saving"
        class="w-full inline-flex items-center justify-center gap-2 px-6 py-3
               rounded-2xl text-slate-950 font-semibold text-sm md:text-base
               hover:brightness-110 active:translate-y-[1px] transition
               disabled:opacity-50 disabled:cursor-not-allowed"
        [ngClass]="isLastExercise 
          ? 'bg-gradient-to-b from-amber-300 to-amber-500 shadow-[0_16px_40px_rgba(245,158,11,0.5)]'
          : 'bg-gradient-to-b from-emerald-300 to-emerald-500 shadow-[0_16px_40px_rgba(16,185,129,0.5)]'"
      >
        <span *ngIf="saving" class="w-4 h-4 border-2 border-slate-950 border-t-transparent rounded-full animate-spin"></span>
        {{ saving ? 'Guardando...' : submitButtonText }}
      </button>
    </section>
    <!-- Siguientes ejercicios -->
    <section class="px-4 mt-6 mb-4" *ngIf="d.nextExercises.length > 0">
      <h3 class="text-[11px] md:text-xs text-slate-400 mb-2">
        Siguientes ejercicios
      </h3>

      <div class="flex flex-col gap-2">
        <div
          *ngFor="let ex of d.nextExercises; index as i"
          class="w-full bg-[#11151a] rounded-2xl px-4 py-3 md:px-5 md:py-4
                 border border-slate-800 hover:border-emerald-400/60 transition
                 flex items-center gap-3 cursor-pointer"
        >
          <div class="flex-1">
            <div class="text-[10px] md:text-[11px] uppercase text-amber-400 mb-1">
              {{ ex.plannedSets }} SERIES ¬∑
              {{ ex.plannedRepsMin }}‚Äì{{ ex.plannedRepsMax }} REPS ¬∑
              {{ ex.plannedRir }} RIR
            </div>

            <p class="text-xs md:text-sm font-semibold">
              {{ ex.exerciseName }}
            </p>
          </div>

          <span class="text-slate-500 text-xs md:text-sm">‚Ä∫</span>
        </div>
      </div>
    </section>

  </div>
</div>
