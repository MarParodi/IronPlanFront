<!-- Loading -->
<div *ngIf="loading" class="min-h-screen bg-[#111416] flex items-center justify-center text-slate-300">
  Cargando ejercicio...
</div>

<!-- Error -->
<div *ngIf="!loading && errorMessage" class="min-h-screen bg-[#111416] flex items-center justify-center text-red-400">
  {{ errorMessage }}
</div>

<!-- Contenido principal -->
<div *ngIf="!loading && data as d" class="min-h-screen bg-[#111416] text-slate-50 flex justify-center">
  <div class="w-full max-w-md md:max-w-lg lg:max-w-xl flex flex-col pb-8">

    <!-- Header con timer -->
    <header class="px-4 pt-4 pb-1 flex items-center justify-between">
      <div class="text-lg md:text-xl font-semibold tabular-nums">{{ timerLabel }}</div>
      <button (click)="onBack()" class="text-slate-400 hover:text-slate-100 text-xl leading-none" aria-label="Cerrar sesi√≥n">‚úï</button>
    </header>

    <p class="px-4 text-xs md:text-sm text-emerald-400 -mt-0.5 mb-2">Sesi√≥n activa</p>

    <!-- Video / imagen -->
    <section class="px-4">
      <div class="relative rounded-3xl overflow-hidden bg-slate-900 aspect-video shadow-[0_18px_50px_rgba(0,0,0,0.85)]">
        <ng-container *ngIf="youtubeEmbedUrl">
          <iframe [src]="youtubeEmbedUrl | safe:'resourceUrl'" class="absolute inset-0 w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </ng-container>
        <ng-container *ngIf="isDirectVideo">
          <video [src]="d.exerciseVideoUrl" class="absolute inset-0 w-full h-full object-cover" controls playsinline></video>
        </ng-container>
        <ng-container *ngIf="!hasVideo">
          <div class="absolute inset-0 bg-gradient-to-b from-slate-800 via-slate-900 to-black flex items-center justify-center">
            <div class="text-center">
              <span class="text-6xl mb-2 block opacity-30">üèãÔ∏è</span>
              <p class="text-slate-500 text-xs">Sin video disponible</p>
            </div>
          </div>
        </ng-container>
        <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/90 via-black/60 to-transparent pointer-events-none">
          <h1 class="text-base md:text-lg font-semibold">{{ d.exerciseName }}</h1>
          <p class="text-xs md:text-sm text-slate-300 mt-1">{{ (d.plannedRestSeconds / 60) | number:'1.0-0' }}‚Ä≤ descanso entre series</p>
        </div>
      </div>
    </section>

    <!-- Progreso -->
    <section class="px-4 mt-3 md:mt-4">
      <div class="flex items-center justify-between text-[11px] md:text-xs text-slate-400">
        <span>{{ d.progress.currentExerciseOrder }}/{{ d.progress.totalExercises }} ejercicios completados ({{ d.progress.progressPercentage | number:'1.0-0' }}%)</span>
        <span class="text-emerald-400 font-semibold">+{{ d.progress.xpEarned }} XP ganados</span>
      </div>
      <div class="w-full bg-slate-800 rounded-full h-2 mt-2 overflow-hidden">
        <div class="h-2 bg-emerald-400 transition-all" [style.width.%]="d.progress.progressPercentage"></div>
      </div>
    </section>

    <!-- Tarjeta principal del ejercicio -->
    <section class="px-4 mt-4">
      <div class="bg-[#11151a] rounded-3xl p-4 md:p-5 shadow-[0_18px_50px_rgba(0,0,0,0.7)] border border-slate-800">
        <h2 class="font-semibold text-sm md:text-base mb-3">{{ d.exerciseName }}</h2>
        <div class="flex flex-wrap gap-2 text-[10px] md:text-[11px]">
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-amber-500 text-slate-950 font-semibold tracking-wide">{{ d.plannedSets }} SERIES</span>
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-500/15 border border-emerald-300 text-emerald-200 font-semibold tracking-wide">{{ d.plannedRepsMin }}‚Äì{{ d.plannedRepsMax }} REPS</span>
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-slate-900 border border-slate-600">{{ d.plannedRir }} RIR</span>
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-slate-900 border border-slate-600">{{ d.plannedRestSeconds / 60 | number:'1.0-0' }}‚Ä≤ entre series</span>
        </div>
      </div>
    </section>

    <!-- Recomendaci√≥n de progresi√≥n -->
    <section class="px-4 mt-3" *ngIf="recommendation || loadingRecommendation">
      <button (click)="openRecommendationModal()" [disabled]="loadingRecommendation" class="w-full p-3 rounded-2xl border transition-all" [ngClass]="getRecommendationBgColor()">
        <div *ngIf="loadingRecommendation" class="flex items-center justify-center gap-2">
          <div class="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>
          <span class="text-xs text-slate-400">Analizando historial...</span>
        </div>
        <div *ngIf="!loadingRecommendation && recommendation" class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold bg-slate-800/60" [ngClass]="getRecommendationColor()">{{ getRecommendationIcon() }}</div>
          <div class="flex-1 text-left">
            <div class="flex items-center gap-2">
              <span class="text-[10px] uppercase font-semibold tracking-wider" [ngClass]="getRecommendationColor()">Sugerencia</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"></path>
              </svg>
            </div>
            <p class="text-xs text-slate-300 mt-0.5 line-clamp-2">{{ recommendation.message }}</p>
          </div>
          <div *ngIf="recommendation.suggestedWeightKg" class="text-right">
            <span class="text-lg font-bold" [ngClass]="getRecommendationColor()">{{ recommendation.suggestedWeightKg | number:'1.1-1' }}</span>
            <span class="text-xs text-slate-400 block">kg</span>
          </div>
        </div>
      </button>
    </section>

    <!-- Registro de series -->
    <section class="px-4 mt-5">
      <h3 class="font-semibold text-sm md:text-base mb-3">Registro de series</h3>
      <div class="space-y-3 text-xs md:text-sm">
        <div *ngFor="let s of currentSets; index as i" class="grid grid-cols-[auto_1fr_1fr_auto] items-center gap-2 md:gap-3">
          <span class="text-slate-400">Serie {{ i + 1 }}</span>
          <input type="number" class="w-full bg-[#10141a] border border-slate-700 rounded-2xl px-3 py-2 text-xs md:text-sm focus:outline-none focus:border-emerald-400" placeholder="Reps" [(ngModel)]="currentSets[i].reps">
          <input type="number" class="w-full bg-[#10141a] border border-slate-700 rounded-2xl px-3 py-2 text-xs md:text-sm focus:outline-none focus:border-emerald-400" placeholder="kg" [(ngModel)]="currentSets[i].weightKg">
          <button type="button" class="w-8 h-8 md:w-9 md:h-9 rounded-xl border flex items-center justify-center transition" [ngClass]="currentSets[i].completed ? 'border-emerald-400 bg-emerald-400/20' : 'border-slate-700'" (click)="onToggleSetCompleted(i)">
            <span *ngIf="currentSets[i].completed">‚úî</span>
          </button>
        </div>
      </div>
      <p *ngIf="d.previousSet" class="mt-3 text-[11px] md:text-xs text-slate-400">Serie anterior: {{ d.previousSet.reps }} reps √ó {{ d.previousSet.weightKg }} kg</p>
    </section>

    <!-- Notas -->
    <section class="px-4 mt-5">
      <h3 class="font-semibold text-sm md:text-base mb-2">Tus notas +</h3>
      <textarea rows="3" class="w-full bg-[#10141a] border border-slate-700 rounded-2xl px-3 py-2 text-xs md:text-sm placeholder:text-slate-500 focus:outline-none focus:border-emerald-400" placeholder="Agrega observaciones sobre esta sesi√≥n..." [(ngModel)]="notes"></textarea>
    </section>

    <!-- Bot√≥n registrar -->
    <section class="px-4 mt-5">
      <button (click)="onRegisterAndContinue()" [disabled]="saving" class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 rounded-2xl text-slate-950 font-semibold text-sm md:text-base hover:brightness-110 active:translate-y-[1px] transition disabled:opacity-50 disabled:cursor-not-allowed" [ngClass]="isLastExercise ? 'bg-gradient-to-b from-amber-300 to-amber-500 shadow-[0_16px_40px_rgba(245,158,11,0.5)]' : 'bg-gradient-to-b from-emerald-300 to-emerald-500 shadow-[0_16px_40px_rgba(16,185,129,0.5)]'">
        <span *ngIf="saving" class="w-4 h-4 border-2 border-slate-950 border-t-transparent rounded-full animate-spin"></span>
        {{ saving ? 'Guardando...' : submitButtonText }}
      </button>
    </section>

    <!-- Siguientes ejercicios -->
    <section class="px-4 mt-6 mb-4" *ngIf="d.nextExercises.length > 0">
      <h3 class="text-[11px] md:text-xs text-slate-400 mb-2">Siguientes ejercicios</h3>
      <div class="flex flex-col gap-2">
        <div *ngFor="let ex of d.nextExercises; index as i" class="w-full bg-[#11151a] rounded-2xl px-4 py-3 md:px-5 md:py-4 border border-slate-800 hover:border-emerald-400/60 transition flex items-center gap-3 cursor-pointer">
          <div class="flex-1">
            <div class="text-[10px] md:text-[11px] uppercase text-amber-400 mb-1">{{ ex.plannedSets }} SERIES ¬∑ {{ ex.plannedRepsMin }}‚Äì{{ ex.plannedRepsMax }} REPS ¬∑ {{ ex.plannedRir }} RIR</div>
            <p class="text-xs md:text-sm font-semibold">{{ ex.exerciseName }}</p>
          </div>
          <span class="text-slate-500 text-xs md:text-sm">‚Ä∫</span>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Modal de Confirmaci√≥n de Salida -->
<div *ngIf="showExitModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" (click)="closeExitModal()">
  <div class="w-full max-w-sm bg-gradient-to-b from-[#1a1f25] to-[#111416] rounded-2xl border border-slate-700/50 shadow-2xl overflow-hidden" (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="p-5 text-center border-b border-slate-800/60">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-500/20 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
        </svg>
      </div>
      <h3 class="text-lg font-bold text-white">¬øTerminar sesi√≥n?</h3>
      <p class="mt-2 text-sm text-slate-400">Elige c√≥mo quieres terminar tu entrenamiento</p>
    </div>
    
    <!-- Opciones -->
    <div class="p-4 space-y-3">
      <!-- Opci√≥n: Guardar y terminar -->
      <button (click)="onFinishSession()" [disabled]="processingExit" 
              class="w-full p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/30 hover:bg-emerald-500/20 transition-all text-left group">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-emerald-400">Guardar y terminar</p>
            <p class="text-xs text-slate-400 mt-0.5">Se guardar√° tu progreso actual</p>
          </div>
          <div *ngIf="processingExit" class="w-5 h-5 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
        </div>
      </button>

      <!-- Opci√≥n: Descartar -->
      <button (click)="onDiscardSession()" [disabled]="processingExit"
              class="w-full p-4 rounded-xl bg-rose-500/10 border border-rose-500/30 hover:bg-rose-500/20 transition-all text-left group">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-rose-500/20 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-rose-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>
          </div>
          <div class="flex-1">
            <p class="font-semibold text-rose-400">Descartar sesi√≥n</p>
            <p class="text-xs text-slate-400 mt-0.5">Se perder√° todo el progreso</p>
          </div>
          <div *ngIf="processingExit" class="w-5 h-5 border-2 border-rose-400 border-t-transparent rounded-full animate-spin"></div>
        </div>
      </button>
    </div>

    <!-- Bot√≥n cancelar -->
    <div class="px-4 pb-4">
      <button (click)="closeExitModal()" [disabled]="processingExit"
              class="w-full py-3 rounded-xl bg-slate-800/60 border border-slate-700/50 text-slate-300 font-medium hover:bg-slate-700/60 transition-all">
        Continuar entrenando
      </button>
    </div>
  </div>
</div>

<!-- Modal de Recomendaci√≥n Detallada -->
<div *ngIf="showRecommendationModal && recommendation" class="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 bg-black/70 backdrop-blur-sm" (click)="closeRecommendationModal()">
  <div class="w-full md:max-w-md bg-gradient-to-b from-[#1a1f25] to-[#111416] rounded-t-3xl md:rounded-2xl border-t md:border border-slate-700/50 shadow-2xl max-h-[85vh] overflow-y-auto" (click)="$event.stopPropagation()">
    <div class="flex justify-center pt-3 pb-2 md:hidden">
      <div class="w-10 h-1 bg-slate-600 rounded-full"></div>
    </div>
    <div class="px-5 pt-4 pb-3 flex items-center justify-between border-b border-slate-800/60">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold bg-slate-800/60" [ngClass]="getRecommendationColor()">{{ getRecommendationIcon() }}</div>
        <div>
          <h3 class="font-semibold text-white">Sugerencia de Progresi√≥n</h3>
          <p class="text-xs text-slate-400">Basada en tus √∫ltimos entrenamientos</p>
        </div>
      </div>
      <button (click)="closeRecommendationModal()" class="text-slate-400 hover:text-white text-xl">√ó</button>
    </div>
    <div class="p-5 space-y-4">
      <div class="p-4 rounded-xl" [ngClass]="getRecommendationBgColor()">
        <p class="text-sm text-slate-200">{{ recommendation.message }}</p>
      </div>
      <div *ngIf="recommendation.suggestedWeightKg || recommendation.suggestedRepsTarget" class="grid grid-cols-2 gap-3">
        <div *ngIf="recommendation.suggestedWeightKg" class="p-4 rounded-xl bg-slate-800/40 text-center">
          <span class="text-2xl font-bold text-white">{{ recommendation.suggestedWeightKg | number:'1.1-1' }}</span>
          <span class="text-slate-400 block text-xs mt-1">kg sugeridos</span>
        </div>
        <div *ngIf="recommendation.suggestedRepsTarget" class="p-4 rounded-xl bg-slate-800/40 text-center">
          <span class="text-2xl font-bold text-white">{{ recommendation.suggestedRepsTarget }}</span>
          <span class="text-slate-400 block text-xs mt-1">reps objetivo</span>
        </div>
      </div>
      <div *ngIf="recommendation.recentPerformance && recommendation.recentPerformance.length > 0">
        <h4 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">√öltimos entrenamientos</h4>
        <div class="space-y-2">
          <div *ngFor="let perf of recommendation.recentPerformance" class="p-3 rounded-xl bg-slate-800/30 flex items-center justify-between">
            <div>
              <p class="text-xs text-slate-400">{{ perf.date | date:'d MMM' }}</p>
              <p class="text-sm text-white font-medium">{{ perf.weightKg | number:'1.1-1' }} kg √ó {{ perf.avgReps }} reps</p>
            </div>
            <div class="flex gap-2">
              <span *ngIf="perf.hitMaxReps" class="px-2 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-500/20 text-emerald-400">‚úì Max</span>
              <span *ngIf="!perf.hitMinReps" class="px-2 py-0.5 rounded-full text-[10px] font-semibold bg-rose-500/20 text-rose-400">‚Üì Min</span>
            </div>
          </div>
        </div>
      </div>
      <button *ngIf="recommendation.suggestedWeightKg" (click)="applySuggestedWeight(recommendation.suggestedWeightKg); closeRecommendationModal()" class="w-full py-3 rounded-xl font-semibold transition-all text-white hover:brightness-110" [ngClass]="getRecommendationBgColor()">
        Aplicar {{ recommendation.suggestedWeightKg | number:'1.1-1' }} kg a todas las series
      </button>
    </div>
  </div>
</div>
