<ng-container *ngIf="loading; else loaded">
  <div class="min-h-screen bg-[#111416] text-slate-100 flex items-center justify-center">
    <p class="text-slate-400 text-sm">Cargando rutina...</p>
  </div>
</ng-container>

<ng-template #loaded>
  <div class="min-h-screen bg-[#111416] text-slate-100" *ngIf="routine as r; else errorTpl">
    <div class="max-w-4xl mx-auto px-4 lg:px-8 pb-10">

      <!-- Back -->
      <button
        (click)="onBack()"
        class="flex items-center gap-2 py-4 text-sm text-slate-300 hover:text-slate-100 transition"
      >
        â† Volver
      </button>

      <!-- HERO: tÃ­tulo + resumen -->
      <section
        class="bg-[#171a1d] rounded-3xl shadow-[0_18px_60px_rgba(0,0,0,0.7)]
               px-5 py-6 md:px-8 md:py-8
               flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
      >
        <!-- TÃ­tulo -->
        <div class="text-center md:text-left space-y-1">
          <h1 class="text-2xl md:text-3xl font-extrabold leading-snug">
            {{ r.name }}
          </h1>
          <p class="text-sm md:text-base text-slate-400">
            {{ r.durationWeeks }} semanas de entrenamiento
          </p>
        </div>

        <!-- Chips principales -->
        <div
          class="flex flex-wrap justify-center md:justify-end gap-2 text-[11px] md:text-xs"
        >
          <span
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full
                   bg-slate-900 border border-teal-400/60 text-teal-300 font-semibold"
          >
            ğŸ§¬ {{ r.goal }}
          </span>

          <span
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full
                   bg-slate-900 border border-amber-400/60 text-amber-300 font-semibold"
          >
            â­ {{ r.recommendedLevel }}
          </span>

          <span
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full
                   bg-slate-900 border border-slate-600 text-slate-100"
          >
            ğŸ“† {{ r.daysPerWeek }} dÃ­as/semana
          </span>
        </div>
      </section>

      <!-- DescripciÃ³n -->
      <section class="mt-7 space-y-3 text-sm md:text-base leading-relaxed text-slate-200">
        <p>
          {{ r.longDescription }}
        </p>
        <p class="text-slate-400">
          Recomendada para nivel
          <span class="font-semibold text-teal-300">
            {{ r.recommendedLevel }}
          </span>
    
        </p>
      </section>

      <!-- BotÃ³n principal -->
      <div class="mt-8">
        <button
          (click)="onStartRoutine()"
          [disabled]="startingRoutine || checkingCurrentRoutine"
          class="w-full md:w-auto md:min-w-[220px] inline-flex items-center justify-center gap-2 px-6 py-3
                 rounded-2xl bg-teal-400 text-slate-950 font-semibold text-sm md:text-base
                 hover:brightness-110 active:translate-y-[1px] transition
                 shadow-[0_10px_25px_rgba(45,212,191,0.4)]
                 disabled:opacity-60 disabled:cursor-not-allowed"
        >
          <!-- Spinner cuando estÃ¡ cargando -->
          <svg *ngIf="startingRoutine || checkingCurrentRoutine" class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span *ngIf="!startingRoutine && !checkingCurrentRoutine">Empezar rutina</span>
          <span *ngIf="checkingCurrentRoutine">Verificando...</span>
          <span *ngIf="startingRoutine && !checkingCurrentRoutine">Asignando...</span>
        </button>
      </div>

      <!-- Bloques / sesiones -->
      <section class="mt-8" *ngIf="r.blocks?.length">
        

        <div class="space-y-6">
          <div *ngFor="let b of r.blocks; trackBy: trackByBlock" class="space-y-3">
            <h3 class="text-teal-200 font-semibold text-xs md:text-sm uppercase tracking-wide">
              {{ b.name }}
              <span *ngIf="b.durationWeeks" class="text-slate-500 font-normal">
                â€” {{ b.durationWeeks }} semanas
              </span>
            </h3>

            <div class="space-y-3">
              <div
                *ngFor="let s of b.sessions; trackBy: trackBySession"
                class="bg-[#171a1d] rounded-2xl px-4 py-3 md:px-5 md:py-4
                       flex items-center justify-between gap-3 shadow-md
                       border border-slate-800/60 opacity-75"
              >
                <div class="flex-1">
                  <p class="text-sm md:text-base font-semibold uppercase tracking-wide text-slate-300">
                    {{ s.title }}
                  </p>
                  <p class="text-xs md:text-sm text-amber-400/70">
                    {{ s.totalSeries }} series
                  </p>
                  <p class="text-xs md:text-sm text-slate-500">
                    {{ s.mainMuscles }}
                  </p>
                </div>
                <!-- Icono de candado -->
                <div class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      

     
    </div>
  </div>

  <ng-template #errorTpl>
    <div class="min-h-screen bg-[#111416] text-slate-100 flex items-center justify-center">
      <p class="text-red-400 text-sm">
        {{ error || 'OcurriÃ³ un error al cargar la rutina.' }}
      </p>
    </div>
  </ng-template>
</ng-template>

<!-- Modal de ConfirmaciÃ³n de Cambio de Rutina -->
<div *ngIf="showChangeRoutineModal && currentRoutine" 
     class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"
     (click)="closeChangeRoutineModal()">
  <div class="w-full max-w-sm bg-gradient-to-b from-[#1a1f25] to-[#111416] rounded-2xl border border-slate-700/50 shadow-2xl overflow-hidden"
       (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="p-5 text-center border-b border-slate-800/60">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-amber-500/20 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
        </svg>
      </div>
      <h3 class="text-lg font-bold text-white">Ya tienes una rutina activa</h3>
      <p class="mt-2 text-sm text-slate-400">Â¿Deseas cambiar a esta nueva rutina?</p>
    </div>
    
    <!-- Contenido -->
    <div class="p-5 space-y-4">
      <!-- Rutina actual -->
      <div class="p-4 rounded-xl bg-slate-800/40 border border-slate-700/40">
        <p class="text-[10px] uppercase tracking-wider text-slate-500 mb-1">Rutina actual</p>
        <p class="font-semibold text-white">{{ currentRoutine.name }}</p>
        <p class="text-xs text-slate-400 mt-1">{{ currentRoutine.daysPerWeek }} dÃ­as/sem Â· {{ currentRoutine.durationWeeks }} semanas</p>
      </div>

      <!-- Nueva rutina -->
      <div class="p-4 rounded-xl bg-teal-500/10 border border-teal-500/30">
        <p class="text-[10px] uppercase tracking-wider text-teal-400 mb-1">Nueva rutina</p>
        <p class="font-semibold text-white">{{ routine?.name }}</p>
        <p class="text-xs text-slate-400 mt-1">{{ routine?.daysPerWeek }} dÃ­as/sem Â· {{ routine?.durationWeeks }} semanas</p>
      </div>

      <!-- Advertencia -->
      <div class="flex items-start gap-3 p-3 rounded-xl bg-rose-500/10 border border-rose-500/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-rose-400 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
        </svg>
        <p class="text-xs text-rose-300">El progreso de tu rutina actual se perderÃ¡ al cambiar a otra.</p>
      </div>
    </div>

    <!-- Botones -->
    <div class="px-5 pb-5 space-y-3">
      <button (click)="confirmStartRoutine()" 
              [disabled]="startingRoutine"
              class="w-full py-3 rounded-xl bg-teal-500 hover:bg-teal-400 text-slate-950 font-semibold transition-all flex items-center justify-center gap-2">
        <svg *ngIf="startingRoutine" class="animate-spin w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>{{ startingRoutine ? 'Cambiando...' : 'SÃ­, cambiar de rutina' }}</span>
      </button>
      
      <button (click)="closeChangeRoutineModal()" 
              [disabled]="startingRoutine"
              class="w-full py-3 rounded-xl bg-slate-800/60 border border-slate-700/50 text-slate-300 font-medium hover:bg-slate-700/60 transition-all">
        No, mantener mi rutina actual
      </button>
    </div>
  </div>
</div>
